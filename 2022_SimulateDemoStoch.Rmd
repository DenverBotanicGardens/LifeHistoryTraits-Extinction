---
title: "Simulate Demographic stochasticity"
output: html_document
---




Load 
```{r}
dateSaved <- "2022-03-09"

load(paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/Time2Ext.demo.stpopsz,sig2", dateSaved,".Rdata", sep = ""))

lmbds.demo <- do.call(rbind,lapply(PopDyn.lh.sig.popsz, function(i1){
  i1out <- do.call(rbind, lapply(i1, function(i2){
    i2[[1]]
  }))
  i1out
}))

PopDyn.demo <- do.call(rbind,lapply(PopDyn.lh.sig.popsz, function(i1){
  i1out <- do.call(rbind, lapply(i1, function(i2){
    i2[[2]]
  }))
  i1out
}))

rm(PopDyn.lh.sig.popsz)
gc()
```


Add a parallel process to speed up 2022-03-03
```{r, eval = FALSE}
detectCores() # 12
registerDoParallel(10) # .onUnload will automatically stop the cluster 

StPopSz <- c(50,100,500)
sig2d <- seq(0.001, 1e-5, length.out = 3)
sampsz <- 999
Y <- 100

PopDyn.lh.sig.popsz <- 
  foreach(SPS = StPopSz, .packages = c("popbio","foreach"), .combine = c, 
          .multicombine = TRUE) %dopar% {
    foreach(s2s = sig2d) %dopar% {    # PopDyn.lh <- .combine = 'comb'
      foreach(rowN = 1:nrow(lh)) %do% {      # sig2.1 <-    , .combine = 'comb'
        
        MPMs1 <- MPM_stoch(sampsz = sampsz, age1 = lh$age[rowN],
                           p_a = lh$P_a[rowN], p_j = lh$P_j[rowN],
                           m1 = lh$m[rowN], sig2D = s2s)
        
        lmbds <- data.frame(age = lh$age[rowN],
                            p_j = lh$P_j[rowN],
                            p_a = lh$P_a[rowN],
                            m = lh$m[rowN],
                            sig2D = s2s,
                            Lambda = unlist(lapply(MPMs1, function(x) lambda(x))),
                            TraitSpsig2D = unlist(lapply(MPMs1, function(x) sig2Dts.A(x))))
        
        PopDyn <- ER(MPMs = MPMs1, Y = Y, StPopSz = SPS, sig2D = s2s,
                     age1 = lh$age[rowN],
                     p_a = lh$P_a[rowN],
                     p_j = lh$P_j[rowN],
                     m1 = lh$m[rowN])
        
        Time2Ext <- data.frame(A_LH = rowN, do.call(rbind, lapply(PopDyn, function(er){
          er[nrow(er),]
          })))
    list(lmbds, Time2Ext)
      }
    }
  }

save(PopDyn.lh.sig.popsz, file = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/Time2Ext.demo.stpopsz,sig2", Sys.Date(),".Rdata", sep = ""))

lmbds.demo <- do.call(rbind,lapply(PopDyn.lh.sig.popsz, function(i1){
  i1out <- do.call(rbind, lapply(i1, function(i2){
    i2[[1]]
  }))
  i1out
}))

PopDyn.demo <- do.call(rbind,lapply(PopDyn.lh.sig.popsz, function(i1){
  i1out <- do.call(rbind, lapply(i1, function(i2){
    i2[[2]]
  }))
  i1out
}))

rm(PopDyn.lh.sig.popsz)
gc()
```


```{r}
# Create lmbds.demo and PopDyn in first chunk
lmbds.demo$parity <- ifelse(lmbds.demo$p_a == 0, "semel", "itero")
lmbds.demo$agebin <- cut_number(lmbds.demo$age, 3)

lmbds.demo$mbin <- ifelse(lmbds.demo$m < 16, 
                          as.character(cut_number(lmbds.demo$m[lmbds.demo$m < 16], 3)), 
                            as.character(cut_number(lmbds.demo$m[lmbds.demo$m > 15], 3)))
lmbds.demo$mbin <- factor(lmbds.demo$mbin, 
                          levels = levels(as.factor(lmbds.demo$mbin))[c(5,1,4,6,3,2)])
lmbds.demo$pjbin <- cut_number(lmbds.demo$p_j, 3) # groups with ca == # obs
lmbds.demo$pabin <- ifelse(lmbds.demo$p_a == 0, "[0,0]", "(0,0.95]")# cut_number(lmbds.demo$p_a, 2)
lmbds.demo$pabin <- as.character(lmbds.demo$pabin)
lmbds.demo$pabin[lmbds.demo$parity == "itero"] <- 
  as.character(cut_number(lmbds.demo$p_a[lmbds.demo$parity == "itero"], 3))
lmbds.demo$pabin <- factor(lmbds.demo$pabin, 
                            levels = levels(as.factor(lmbds.demo$pabin))[c(3,4,1,2)])


colfunc<-colorRampPalette(c("red","yellow","springgreen","royalblue"))

## difference from 1 in lambda by life history
demoPla <- ggplot(lmbds.demo, aes(y = (Lambda-1), x= as.factor(sig2D), colour = as.factor(agebin)))+
  geom_boxplot()+
  theme_bw()+
  facet_grid(~parity)+
  ylab(expression(Delta~lambda))+
  scale_color_manual(expression(alpha), values = colfunc(3))+ # guide = "none")+ #
  # xlab(expression(sigma[D]^2))+
  xlab("")+
  ggtitle("a)")
  
demoPlb <- ggplot(lmbds.demo, aes(y= (Lambda-1), x= as.factor(sig2D), colour = pjbin))+
  geom_boxplot()+
  theme_bw()+
  facet_grid(~parity)+
  ylab(expression(Delta~lambda))+
  scale_color_manual(expression(P[j]),
                     values = colfunc(3))+
  xlab("")+
  ggtitle("b)")

demoPlc <- ggplot(lmbds.demo, aes(y=(Lambda-1), x= as.factor(sig2D), colour = mbin))+
  geom_boxplot()+
  theme_bw()+
  facet_grid(~parity)+
  ylab(expression(Delta~lambda))+
  scale_color_manual(expression(m), values = colfunc(6))+
  xlab(expression(sigma[D]^2))+
  ggtitle("c)")

demoPld <- ggplot(lmbds.demo, aes(y=(Lambda-1), x= as.factor(sig2D), colour = pabin))+
  geom_boxplot()+
  theme_bw()+
  facet_grid(~parity)+
  ylab(expression(Delta~lambda))+
  scale_color_manual(expression(P[a]), values = colfunc(4))+
  xlab(expression(sigma[D]^2))+
  ggtitle("d)")

ggsave(filename = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/Demolambdas", Sys.Date(),".jpg", sep=""),
 (demoPla + demoPlb)/(demoPlc + demoPld),
width=250, height=190,units='mm', dpi=300)


rm(lmbds.demo)
gc()

```


#################### 2022-03-01 #################### 

```{r}


PopDyn.demo$parity <- "itero"
PopDyn.demo$parity[PopDyn.demo$p_a == 0] <- "semel"
PopDyn.demo$pjbin <- cut_number(PopDyn.demo$p_j, 3) # groups with ca == # obs
PopDyn.demo$pabin <- ifelse(PopDyn.demo$p_a == 0, "[0,0]", 
                            as.character(cut_number(PopDyn.demo$p_a[PopDyn.demo$p_a > 0], 3)))
PopDyn.demo$pabin <- factor(PopDyn.demo$pabin, 
                            levels = levels(as.factor(PopDyn.demo$pabin))[c(3,4,1,2)])

PopDyn.demo$agebin <-  cut_number(PopDyn.demo$age, 3)

PopDyn.demo$mbin <- ifelse(PopDyn.demo$m < 16, 
                           as.character(cut(PopDyn.demo$m[PopDyn.demo$m < 16], 
                                            breaks = c(0,2,5,15))), 
                            as.character(cut_number(PopDyn.demo$m[PopDyn.demo$m > 15], 3)))
PopDyn.demo$mbin <- factor(PopDyn.demo$mbin, 
                             levels = levels(as.factor(PopDyn.demo$mbin))[c(1,2,5,6,4,3)],
                           labels = c("[1,2]",levels(as.factor(PopDyn.demo$mbin))[c(2,5,6,4,3)]))


colfunc<-colorRampPalette(c("red","gold","springgreen","royalblue"))
```

```{r}
Time2Extc <- ggplot(PopDyn.demo, aes(Year, colour = mbin, group = as.factor(mbin)))+
  stat_ecdf(size = 1)+
  theme_bw()+
  facet_grid(sig2D ~ parity + StPopSz)+
  scale_colour_manual(expression(m),
                      values = colfunc(6))+
  coord_cartesian(xlim = c(0,93), ylim = c(0,0.35))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  xlab("Year")+
  ggtitle("c)")+
  ylab("Extinction Risk")


Time2Exta <- ggplot(PopDyn.demo, aes(Year, colour = agebin, group = as.factor(agebin)))+
  stat_ecdf(size = 1)+
  theme_bw()+
  facet_grid(sig2D ~ parity + StPopSz, scales = "free")+ # p_j = row, p_a = col
  # scale_colour_discrete(expression(m[fecundity]))+
  scale_colour_manual(expression(alpha),values = colfunc(3))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  coord_cartesian(xlim = c(0,93), ylim = c(0,0.4))+
  # xlab("Year")+
  xlab("")+
  ggtitle("a)")+
  ylab("Extinction Risk")
  

Time2Extb <- ggplot(PopDyn.demo, aes(Year, colour = pjbin))+
  stat_ecdf(size=1)+
  theme_bw()+
  facet_grid(sig2D ~ parity + StPopSz)+
  scale_color_manual(expression(P[j]),values=colfunc(3))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  coord_cartesian(xlim = c(0,93), ylim = c(0,0.4))+
  xlab("")+
  ggtitle("b)")+
  ylab("")

Time2Extd <- ggplot(PopDyn.demo, aes(Year, colour = pabin))+
  stat_ecdf(size = 1)+
  theme_bw()+
  facet_grid(sig2D ~ parity + StPopSz)+
  scale_color_manual(expression(P[a]),values=colfunc(4))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  coord_cartesian(xlim = c(0,93), ylim = c(0,0.3))+
  xlab("Year")+
  ggtitle("d)")+
  ylab("")

ggsave(filename = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/DemoTime2Ext", Sys.Date(),".jpg", sep=""),
  (Time2Exta + Time2Extb)/(Time2Extc + Time2Extd),
width=270, height=200,units='mm', dpi=300)
```


```{r}
ProbExt.demo <- do.call(rbind,lapply(split(PopDyn.demo, list(PopDyn.demo$A_LH,
                                                             PopDyn.demo$StPopSz,
                                                             PopDyn.demo$sig2D)), 
                     function(x){
                     data.frame(A_LH = x$A_LH[1], StPopSz = x$StPopSz[1], sig2d = x$sig2D[1],
                                age = x$age[1], m = x$m[1], p_a = x$p_a[1], p_j = x$p_j[1],
                                mbin = x$mbin[1], parity = x$parity[1], pjbin = x$pjbin[1],
                                pabin = x$pabin[1], agebin = x$agebin[1],
                                ProbExt100yrs = sum(x$Ext)/nrow(x),
                                ProbExt30yrs = sum(x$Ext[x$Year < 31])/nrow(x),
                                ProbExt10yrs = sum(x$Ext[x$Year < 11])/nrow(x)) 
                       }))

```

```{r}
EPa <- ggplot(ProbExt.demo, aes(x = as.factor(sig2d), ProbExt10yrs, color = as.factor(agebin)))+
  geom_boxplot()+
  theme_bw()+
  scale_color_manual(expression(alpha), values = colfunc(3))+
  facet_grid(parity ~  StPopSz)+
  xlab(expression(sigma[D]^2))+
  ylab("EP (10 years)")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  ggtitle("a)")

EPb <- ggplot(ProbExt.demo, aes(x = as.factor(sig2d),
                                   ProbExt10yrs, colour = as.factor(pjbin)))+
  geom_boxplot()+
  theme_bw()+
  scale_color_manual(expression(P[j]), values = colfunc(4))+
  facet_grid(parity ~  StPopSz)+
  xlab(expression(sigma[D]^2))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  ylab("EP (10 years)")+
  ggtitle("b)")
EPc <- ggplot(ProbExt.demo, aes(x = as.factor(sig2d),
                                   ProbExt10yrs, colour = as.factor(mbin)))+
  geom_boxplot()+
  theme_bw()+
  scale_color_manual(expression(m), values = colfunc(6))+
  facet_grid(parity ~  StPopSz)+
  xlab(expression(sigma[D]^2))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  ylab("EP (10 years)")+
  ggtitle("c)")
EPd <- ggplot(ProbExt.demo, aes(x = as.factor(sig2d),
                                   ProbExt10yrs, colour = as.factor(pabin)))+
  geom_boxplot()+
  scale_color_manual(expression(P[a]), values = colfunc(4))+
  theme_bw()+
  facet_grid(parity ~  StPopSz)+
  xlab(expression(sigma[D]^2))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  ylab("EP (10 years)")+
  ggtitle("c)")
ggsave(filename = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/ProbExt_demo10yrs", Sys.Date(),".jpg", sep=""),
  (EPa + EPb)/(EPc + EPd)+
  plot_annotation(title = "Demographic Stochasticity",
                  caption = expression("m: fecudnity;"~alpha*": age of reproductive maturity;"~P[j]*": juvenile survival;"~P[a]~": adult survival")),
width=270, height=210,units='mm', dpi=300)
```

```{r}
gc()

lmbds.demo$mbin <- cut_interval(lmbds.demo$m, length = 100)
lmbds.demo$parity <- "itero"
lmbds.demo$parity[lmbds.demo$p_a == 0] <- "semel"
lmbds.demo$pjbin <- cut_number(lmbds.demo$p_j, 3)
lmbds.demo$pabin <- cut_number(lmbds.demo$p_a, 2)

ggsave(filename = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/Demo", Sys.Date(),"lambda.jpg", sep=""),
  
ggplot(lmbds.demo, aes(Lambda, fill = mbin, group = mbin), alpha = 0.5)+
  geom_histogram(binwidth = 0.05)+
  theme_bw()+
  facet_grid(pjbin + sig2D ~ pabin + parity, scales = "free")+ # p_j = row, p_a = col
  scale_fill_discrete(expression(m[fecundity])),

width=250, height=400,units='mm', dpi=300)


```


########################################################################################

Dinsmore, Wunder, Dreitz, Knopf 2010    

distributional assumptions about each parameter in the model assuming various response to a stochastic environment
the mean value of each parameter is found from life history traits that result in a stable growth rate - these should be viable combinations of vital rates if population is large enough (stable stage) and in the absence of environmental variability. 
Surv_j ~ beta(alpha, beta)
Surv_a ~ beta(alpha, beta)
m ~ Poisson(lambda)
Matrix elements are:
f_j at age of sexual maturity = m * Surv_j
f_a = m * Surv_a
Recruits ~ binomial(m, Surv_j)

```{r}
annuals <- lh[lh$age == 1 & lh$P_a == 0,]
hist(annuals$P_j)
plot(P_j ~ m, data = annuals, type = "b")
## Allowing vital rates to vary, look at the variance in time to extinction due to demographic, environmental, and both types of variance 

```


### Simulate Annuals --> skip to semel and put annuals in with them
Simulate like Dinsmore et al 2010 Mountain Plover
## Annuals compare range of demographic stochasticity in survival
```{r}
# 1. Simulate 1000 annuals, Simulate 1000 long-lived perennials  
annuals <- lh[lh$age==1 & lh$P_a==0 & lh$m %in% c(2,100,500),]
# test levels of sig2D 
sig2s <- c(1e-3, 1e-4, 1e-5)

PopDyn.annuals <- lapply(sig2s, function(s2s){
  sig2.1 <- lapply(1:nrow(annuals), function(rowN){
  MPMs1 <- MPM_stoch(sampsz = sampsz, age1 = annuals$age[rowN],
            p_a = annuals$P_a[rowN], p_j = annuals$P_j[rowN],
            m1 = annuals$m[rowN], sig2D = s2s)
  lmbds <- data.frame(age = annuals$age[rowN],
                      p_j = annuals$P_j[rowN],
               p_a = annuals$P_a[rowN],
               m = annuals$m[rowN],
               sig2D = s2s,
               Lambda = unlist(lapply(MPMs1, function(x) lambda(x))),
               TraitSpsig2D = unlist(lapply(MPMs1, function(x) sig2Dts.A(x))))

  PopDyn <- ER(MPMs = MPMs1, Y = Y, StPopSz = StPopSz, sig2D = s2s,
             age1 = annuals$age[rowN],
             p_a = annuals$P_a[rowN],
             p_j = annuals$P_j[rowN],
             m1 = annuals$m[rowN])
  Time2Ext <- do.call(rbind, lapply(PopDyn, function(er){
    er[nrow(er),]
  }))
  list(lmbds, Time2Ext)
})
  sig2.1
})




## get hist of lambdas for each one
# lmbds <- do.call(rbind,lapply(1:length(annualSim1eneg5), function(sim){
lmbds <- do.call(rbind,lapply(1:length(PopDyn.annuals), function(sim){
  list.out <- do.call(rbind,lapply(1:length(PopDyn.annuals[[sim]]), function(sim2){
    PopDyn.annuals[[sim]][[sim2]][[1]]
  }))
  list.out
}))

head(lmbds)
lmbds[lmbds$Lambda <0.4,]

ggplot(lmbds, aes(sig2D, TraitSpsig2D, group = as.factor(sig2D)))+ 
  geom_violin()+
  facet_wrap(~m)+
  theme_bw()
  # xlab(expression(lambda))+
  # ggtitle("a) Annual: growth rate")





ggsave(filename = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/Demo_allannuals", paste(sig2s,collapse = "-"), Sys.Date(),".jpg", sep=""),
ggplot(lmbds, aes(Lambda, group = as.factor(m)))+ 
  geom_histogram()+
  xlim(c(0,2))+
  theme_bw()+
  facet_grid(m ~ sig2D)+
  xlab(expression(lambda))+
  ggtitle("a) Annual: growth rate"),
width=110, height=110,units='mm', dpi=300)


## Time to extinction for propagules2sample
Time2Ext.subset <- do.call(rbind,lapply(1:length(PopDyn.annuals), function(x){
  list.out <- do.call(rbind, lapply(1:length(PopDyn.annuals[[x]]), function(x1){
    PopDyn.annuals[[x]][[x1]][[2]]
  })) 
}))

ggsave(filename = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/Time2Extannuals",  paste(sig2s,collapse = "-"), Sys.Date(),".jpg", sep=""),
ggplot(Time2Ext.subset, aes(Year))+ #, colour = as.factor(m)))+
  stat_ecdf()+
  theme_bw()+
  facet_grid(m~sig2D)+
  # scale_colour_discrete(expression(m[fecundity]))+
  ylab("Cumulative distribution function")+
  ggtitle("b) Annual: time to extinction"),
width=110, height=110,units='mm', dpi=300)

################################################### Perennials ##########################


# 1. Simulate 1000 annuals, Simulate 1000 long-lived perennials  
(slowperen <- lh[lh$age %in% c(1,10,15) & lh$P_a %in%  c(0.540, 0.795, 0.99) ,]) #0.625, 4 of them
# test levels of sig2D 
sig2s <- c(1e-3, 1e-4, 1e-5)

PopDyn.6pere <- lapply(sig2s, function(s2s){
  sig2.1 <- lapply(1:nrow(slowperen), function(rowN){
  MPMs1 <- MPM_stoch(sampsz = sampsz, age1 = slowperen$age[rowN],
            p_a = slowperen$P_a[rowN], p_j = slowperen$P_j[rowN],
            m1 = slowperen$m[rowN], sig2D = s2s)
  lmbds <- data.frame(age = slowperen$age[rowN],
                      p_j = slowperen$P_j[rowN],
               p_a = slowperen$P_a[rowN],
               m = slowperen$m[rowN],
               sig2D = s2s,
               Lambda = unlist(lapply(MPMs1, function(x) lambda(x))))

  PopDyn <- ER(MPMs = MPMs1, Y = Y, StPopSz = StPopSz, sig2D = s2s,
             age1 = slowperen$age[rowN],
             p_a = slowperen$P_a[rowN],
             p_j = slowperen$P_j[rowN],
             m1 = slowperen$m[rowN])
  Time2Ext <- do.call(rbind, lapply(PopDyn, function(er){
    er[nrow(er),]
  }))
  list(lmbds, Time2Ext)
})
  sig2.1
})

## get hist of lambdas for each one
lmbds.6per <- do.call(rbind,lapply(1:length(PopDyn.6pere), function(sim){
  list.out <- do.call(rbind,lapply(1:length(PopDyn.6pere[[sim]]), function(sim2){
    PopDyn.6pere[[sim]][[sim2]][[1]]
  }))
  list.out
}))

head(lmbds.6per)

ggsave(filename = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/Demo_allpere6", paste(sig2s,collapse = "-"), Sys.Date(),".jpg", sep=""),
ggplot(lmbds.6per, aes(Lambda, fill = as.factor(p_a)))+  # group = as.factor(m) 
  geom_histogram(position="dodge2", binwidth = 0.2)+
  xlim(c(0,2))+
  theme_bw()+
  scale_fill_discrete(expression(P[a]))+
  facet_grid(m ~ sig2D)+ #  + p_a
  xlab(expression(lambda))+
  ggtitle("c) Perennial: growth rate")

,
width=130, height=110,units='mm', dpi=300)


## Time to extinction for propagules2sample
Time2Ext.6per <- do.call(rbind,lapply(1:length(PopDyn.6pere), function(x){
  list.out <- do.call(rbind, lapply(1:length(PopDyn.6pere[[x]]), function(x1){
    PopDyn.6pere[[x]][[x1]][[2]]
  })) 
}))



ggsave(filename = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/Time2Ext6pere",  paste(sig2s,collapse = "-"), Sys.Date(),".jpg", sep=""),
ggplot(Time2Ext.6per, aes(Year, colour = as.factor(p_a)))+ #, colour = as.factor(m)))+
  stat_ecdf()+
  theme_bw()+
  facet_grid(m  ~sig2D)+ #+ p_a
  scale_colour_discrete(expression(P[a]))+
  ylab("Cumulative distribution function")+
  ggtitle("d) Perennial: time to extinction"),
width=130, height=110,units='mm', dpi=300)

```


## Simulate pernnials
```{r}

# ggsave(filename = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/Demo_allperen",
#                         Sys.Date(),"_lifehistories.jpg", sep = ""),

peren_Plotc <- ggplot(lh[lh$P_a>0,], aes(m,P_j,  colour = P_a))+  # perennials
  geom_point()+
  scale_colour_steps(expression(P[a]), low = "grey80", high = "black")+
  xlab(expression(m~"="~alpha))+
  ylab(expression(P[j]))+
  theme_bw()+
  ggtitle("c)")
# ,
# width=150, height=100,units='mm', dpi=300)

perennials[perennials$age != perennials$m,]

pas <- unique(perennials$P_a)
plot(P_j ~ m, data = perennials[perennials$P_a %in% pas[seq(1,length(pas), by = 10)],], 
     col = as.factor(P_a), pch=16)
# 1. Simulate 1000 annuals, Simulate 1000 long-lived perennials  

gc()
perennages <- which(perennials$age %in% c(1,2,5,15))
PopDyn.perennials <- lapply(perennages, function(rowN){
  MPMs1 <- MPM_stoch(sampsz = sampsz, age1 = perennials$age[rowN],
            p_a = perennials$P_a[rowN], p_j = perennials$P_j[rowN],
            m1 = perennials$m[rowN], sig2D = sig2D1)

  lmbds <- data.frame(age = perennials$age[rowN], 
                      p_j = perennials$P_j[rowN],
               p_a = perennials$P_a[rowN],
               m = perennials$m[rowN],
               Lambda = unlist(lapply(MPMs1, function(x) lambda(x))))
    gc()
  PopDyn <- ER(MPMs = MPMs1, Y = Y, StPopSz = StPopSz, sig2D = sig2D1, 
             age1 = perennials$age[rowN],
             p_a = perennials$P_a[rowN], 
             p_j = perennials$P_j[rowN],
             m1 = perennials$m[rowN])
  Time2Ext <- do.call(rbind, lapply(PopDyn, function(er){
    er[nrow(er),]
  }))
  list(lmbds, Time2Ext)
})

## get hist of lambdas for each one
lmbds.per <- do.call(rbind,lapply(1:length(PopDyn.perennials), function(sim){
  PopDyn.perennials[[sim]][[1]]
}))

table(lmbds.per$p_a, lmbds.per$age)
# pas[seq(1,length(pas), by=15)]

# ggsave(filename = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/perennialsallsig2", sig2D1, Sys.Date(),"lambda.jpg", sep=""),
#        
# ggplot(lmbds.per[lmbds.per$p_a %in% c(0.505,0.58, 0.62,0.625,0.76,0.765, 0.85,0.875, 0.91,0.915),],
#        aes(Lambda, fill = p_a, group = as.factor(p_a), alpha = 1))+
#   # geom_density()+
#   geom_histogram(position="dodge2", binwidth = 0.25)+
#   theme_bw()+
#   facet_wrap(~age)+ # , scales = "free"
#   xlab(expression(lambda))+
#   # scale_fill_discrete(expression(m[fecundity]))+
#   # scale_fill_gradientn(expression(P[a]),colours = rainbow(4))+
#   scale_fill_steps(expression(P[a]),low = "gold", high = "blue")+
#   scale_alpha(guide = "none") 
# ,
# width=150, height=100,units='mm', dpi=300)


# jpeg(paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/PerennialsLifeHistories", Sys.Date(), sep = ""),
#      width=150, height=125,units='mm', res=300)
# 
# plot(P_j ~ m, data = perennials[perennials$P_a > 0.9,], col = "blue", pch= 16, ylim = c(0,0.99))
# points(P_j ~ m, data = perennials[perennials$P_a <= 0.9 &
#                                     perennials$P_a > 0.8,], col= "lightblue", pch= 2)
# points(P_j ~ m, data = perennials[perennials$P_a <= 0.8 &
#                                     perennials$P_a > 0.7,], col= "limegreen", pch= 3)
# points(P_j ~ m, data = perennials[perennials$P_a <= 0.7 &
#                                     perennials$P_a > 0.6,], col= "brown", pch= 4)
# points(P_j ~ m, data = perennials[perennials$P_a <= 0.6 &
#                                     perennials$P_a > 0.5,], col= "red", pch= 6)
# legend(1,0.99, legend = c(expression("  1 ">~P[a]>~"0.9"),
#                          expression("0.9">=~P[a]>~"0.8"),
#                          expression("0.8">=~P[a]>~"0.7"),
#                          expression("0.7">=~P[a]>~"0.6"),
#                          expression("0.6">=~P[a]>~"0.5")),
#        col = c( "blue","lightblue","limegreen","brown","red"),
#        pch = c(16,2,3,4,6),
#        bty = "n")
# dev.off()

perennials <- lh[lh$P_a>0,]
perennLHb <-  ggplot(perennials, aes(P_a, P_j, group = age, colour = m))+
         xlim(c(0,1.05))+
         geom_line()+
          geom_point(size = 5, colour="white")+
          geom_point(size = 2, shape =1)+
          # geom_point(size = 1, colour="white")+
          theme_classic()+
          theme(panel.background = element_rect(colour = "black"))+
          # annotate("text", x = perennials$P_a[!duplicated(perennials$age)], 
        annotate("text", x = aggregate(P_a~age, perennials, max)$P_a + 0.065,
                 # y = perennials$P_j[!duplicated(perennials$age)]+0.02,
                 y = aggregate(P_j~age, perennials, min)$P_j+0.004,
                 label = paste("age =", perennials$age[perennials$P_j %in%
                                   perennials$P_j[!duplicated(perennials$age)]]))+
         xlab(expression(P[a]))+
         ylab(expression(P[j]))+
       scale_colour_continuous(expression(m))+
         ggtitle("b)")

################################################################
ggsave(filename = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/Demo_semel_perennialsabc", Sys.Date(),"_lifehistories.jpg", sep = ""),
       
       (semelPlotA + perennLHb)/(peren_Plotc + plot_spacer())
      ,
width=275, height=225,units='mm', dpi=300)


## Time to extinction 
Time2Ext.perr <- do.call(rbind, lapply(1:length(PopDyn.perennials), function(x){
  PopDyn.perennials[[x]][[2]][,c("Year","Lambda","sig2D","age","m","p_a","p_j")]
}))

brks <- unique(Time2Ext.perr$pabin)
binends <- unique( as.numeric(  unlist( strsplit( gsub( "[][(]" , "", levels(brks) ) , ","))))
lbls <- c(binends[-1])


Time2Ext.perr$pabin <- cut_number((Time2Ext.perr$p_a), 7)
ggsave(filename = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/Time2Extperennials", sig2D1, Sys.Date(),".jpg", sep=""),

 ggplot(Time2Ext.perr, aes(Year, colour = pabin, group = pabin))+# as.factor(p_a)))+
   stat_ecdf(size=1.5)+
   theme_bw()+
   facet_wrap(~age)+
   scale_colour_discrete(expression(P[a]))+
   ggtitle(expression("b) "~alpha[age]~" = "~m[fecundity]))+
   ylab("Cumulative distribution function")+
   theme(plot.title = element_text(size = 8,))
 
 ,
width=130, height=100,units='mm', dpi=300)

```


## Simulate semelparous 
```{r}
semels <- lh[lh$P_a == 0,] # & lh$m %in% c(2,10,25,50,250,350,500) & lh$age %in% c(1,2,5,14),]


semelPlotA <-    ggplot(semels, aes(m, P_j, group = age, colour = age))+
        geom_line()+
        geom_point(size = 5, colour="white")+
        geom_point(size = 2, shape =1)+
         annotate("text", x = aggregate(m~age, semels, max)$m+30,
                  y = aggregate(P_j~age, semels, min)$P_j+0.005,
                  label = paste("age =", 
                                semels$age[semels$P_j %in% aggregate(P_j~age, semels, min)$P_j&
                                             semels$m %in%  aggregate(m~age, semels, max)$m]))+
        scale_colour_gradient(guide = "none",low = "black", high = "grey70")+
        theme_classic()+
        theme(panel.background = element_rect(colour = "black"))+
        xlab(expression(m))+
        ylab(expression(P[j]))+
         ggtitle("a)")

# ggsave(filename = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/Demo_allsemels", Sys.Date(),"_lifehistories.jpg", sep = ""),
#        
#        ggplot(semels, aes(m, P_j, group = age, colour = age))+
#         geom_line()+
#         geom_point(size = 5, colour="white")+
#         geom_point(size = 2, shape =1)+
#          annotate("text", x = aggregate(m~age, semels, max)$m+30,
#                   y = aggregate(P_j~age, semels, min)$P_j+0.005,
#                   label = paste("age =", 
#                                 semels$age[semels$P_j %in% aggregate(P_j~age, semels, min)$P_j&
#                                              semels$m %in%  aggregate(m~age, semels, max)$m]))+
#         scale_colour_gradient(guide = "none",low = "black", high = "grey70")+
#         theme_classic()+
#         theme(panel.background = element_rect(colour = "black"))+
#         xlab(expression(m))+
#         ylab(expression(P[j]))+
#          ggtitle("a)")
#        ,
# width=150, height=125,units='mm', dpi=300)

gc()
semelstosim <- which(semels$age %in% c(1,2,5,6,14) & 
        semels$m %in% c(2,10,25,50,250,350,500) & 
        semels$age %in% c(1,2,5,14),)
PopDyn.semel <- lapply(semelstosim, function(rowN){
  MPMs1 <- MPM_stoch(sampsz = sampsz, age1 = semels$age[rowN],
            p_a = semels$P_a[rowN], p_j = semels$P_j[rowN],
            m1 = semels$m[rowN], sig2D = sig2D1)
  lmbds <- data.frame(age = semels$age[rowN], 
                      p_j = semels$P_j[rowN],
               p_a = semels$P_a[rowN],
               m = semels$m[rowN],
               Lambda = unlist(lapply(MPMs1, function(x) lambda(x))))
    gc()
  PopDyn <- ER(MPMs = MPMs1, Y = Y, StPopSz = StPopSz, sig2D = sig2D1, 
             age1 = semels$age[rowN],
             p_a = semels$P_a[rowN], 
             p_j = semels$P_j[rowN],
             m1 = semels$m[rowN])
  Time2Ext <- do.call(rbind, lapply(PopDyn, function(er){
    er[nrow(er),]
  }))
  gc()
  list(lmbds, Time2Ext)
})
## get hist of lambdas for each one
lmbds.sem <- do.call(rbind,lapply(1:length(PopDyn.semel), function(sim){
  PopDyn.semel[[sim]][[1]]
}))

sort(colSums(table(semels$age, semels$m)))
sort(rowSums(table(semels$age, semels$m)))
# propagules2sample <- c(2, 25, 45, 200, 350, 500) ## 50 m has two P_j possible 
# [lmbds.sem$m %in% propagules2sample &
#                    lmbds.sem$age %in% c(2,5,6,14),]

ggsave(filename = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/semelsallsig2", sig2D1, Sys.Date(),"lambda.jpg", sep=""),
       
ggplot(lmbds.sem, aes(Lambda, fill = m, group = as.factor(m), alpha = 0.85))+
  geom_density()+
  theme_bw()+
  # coord_cartesian(xlim = c(0,3.5))+
  facet_wrap(~age, scales = "free")+
  xlab(expression(lambda))+
  scale_fill_gradientn(expression(m[fecundity]), colours = rainbow(3))+#mid="yellow",low="red", midpoint = 100)+
  scale_alpha(guide = "none")+
  ggtitle(expression("a) "~P[a]~" = 0"))
  
,
width=200, height=100,units='mm', dpi=300)


## Time to extinction 
Time2Ext.sem <- do.call(rbind,lapply(1:length(PopDyn.semel), function(x){
  PopDyn.semel[[x]][[2]][,c("Year","Lambda","sig2D","age","m","p_a","p_j")]
  }))

# Time2Ext.sem$agebin <- cut_number(Time2Ext.sem$age,3)
Time2Ext.sem$mbin <- cut_number(Time2Ext.sem$m,7)

ggsave(filename = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Figures/Time2Extsemelparous", sig2D1, Sys.Date(),".jpg", sep=""),
       
ggplot(Time2Ext.sem, aes(Year, colour = m, group = as.factor(m)))+
  stat_ecdf(size = 1.5)+
  theme_bw()+
  facet_wrap(~age)+
  scale_colour_gradientn(expression(m[fecundity]),colours = rainbow(7))+
  ggtitle(expression("a) "~P[a]~" = 0"))+
  ylab("Cumulative distribution function")+
  theme(plot.title = element_text(size = 8,))
,
width=120, height=100,units='mm', dpi=300)


Time2Ext.demo <- rbind(Time2Ext.perr[,1:7],Time2Ext.sem)
save(Time2Ext.demo, file = paste("C:/Users/DePrengm/OneDrive - Denver Botanic Gardens/P drive/My Documents/UCDenver_phd/Dissertation/Chapter3/Rdatas/Time2Ext.demo", Sys.Date(),".Rdata", sep = ""))

```
  